name: 'Setup Environment'
description: 'Setup Python and Cache dependencies'

inputs:
  python-version:
    description: 'Version of Python to set up'
    required: false
    default: '3.8.17'
  read-only:
    description: 'Whether to use the cache in read-only mode'
    required: false
    default: '/restore'

runs:
  using: "composite"
  steps:
    - uses: actions/setup-python@v4
      id: python
      with:
        python-version: ${{ inputs.python-version }}
    - uses: actions/cache${{ inputs.read-only }}@v3
      id: dependency-cache
      with:
        path: .venv
        key: python-venv-${{ runner.os }}-${{ steps.python.outputs.python-version }}-${{ hashFiles('**/setup.py') }}
    - if: steps.dependency-cache.outputs.cache-hit != 'true' && '${{ inputs.read-only }}' != '/restore'
      run: |
        python -m venv .venv
        source .venv/bin/activate
        python -m pip install --upgrade pip
        pip install -e '.[testing,linting,llvm]' --extra-index-url https://download.pytorch.org/whl/cpu
      shell: bash
    - if: steps.dependency-cache.outputs.cache-hit != 'true' || inputs.read-only == '/restore'
      run: pip install -e '.[testing,linting,llvm]' --extra-index-url https://download.pytorch.org/whl/cpu
      shell: bash
